# Copilot instructions — Voice-to-Phone site (Astro)

Purpose: Provide concise, actionable guidance so an AI coding agent can become productive quickly in this repository.

## Big picture (what this repo is)

- Static site built with Astro (v5.x). Content-first: pages are rendered from markdown under `src/content/{english,chinese,spanish}` and collections defined in `src/content.config.ts`.
- Multilingual site: language configuration in `src/config/language.json` and site-level multilingual settings in `.astro/config.generated.json` + `astro.config.mjs` (i18n, trailingSlash behaviour).
- Help content is generated by a Puppeteer scraper and saved into `src/content/help/<lang>/...` — these files are treated as regular content and statically built by Astro.

## Key files and where to look first

- Project entry & dev commands: `package.json` (scripts: `dev`, `build`, `preview`, `test`, `format`, `toml:watch`). Use `npm run dev` locally.
- Content collections & schema: `src/content.config.ts` — defines `help`, `pages`, `services`, etc.
- Language and content paths: `src/config/language.json` (contentDir values) and `src/lib/utils/i18nUtils.ts`.
- Content access helpers: `src/lib/contentParser.astro` provides `getCollectionCTM()` and `getEntryCTM()` (used widely by page templates).
- Scraper: `scripts/scrape-help.mjs` — Puppeteer script that generates help pages (markdown + images). Run with `node scripts/scrape-help.mjs` (files produced under `src/content/help/<lang>/` and `public/images/help/`).
- Page templates:
  - `src/pages/[...lang]/help.astro` — aggregated help index (language-prefixed routing)
  - `src/pages/[...lang]/help/[slug].astro` and `src/pages/help/[slug]/[lang].astro` — section pages (both prefix and suffix language URL styles)
  - `src/pages/help/[slug]/[lang].astro` and `src/pages/help/[slug]/index.astro` — added to support `/help/<slug>/es/` and `/help/<slug>/` patterns
  - `src/pages/[...lang]/help/[slug]/[question].astro` — per-question pages
- Styles used for help UI: `src/styles/components.css` (cards, details styling)

## Conventions & patterns (project-specific)

- Multilingual content lives in language-named subfolders (e.g. `src/content/help/spanish/`). Each language entry uses `contentDir` from `language.json`.
- Routes are represented in frontmatter as `route` (note: this project uses `trailingSlash` config; routes generated by scripts include trailing `/` when site expects `always`).
- Help pages:
  - Section files: `src/content/help/<lang>/<section>.md` with frontmatter: `route`, `title`, `qids` (list of question ids), `description`.
  - Question pages: `src/content/help/<lang>/<section>/<question>.md` with frontmatter: `route`, `parent`, `id`, `draft: false`.
- Index file: aggregated index file is `src/content/help/<lang>/-index.md` (contains card grid HTML). Keep index minimal (cards only); actual Q/A lives on section pages.
- Generated assets (images) are stored under `public/images/help/` — commit them with the content.
- Code style: run `npm run format` (Prettier with plugins) before committing; repo enforces certain plugins (Astro, Tailwind, TOML).

## Developer workflows & commands

- Setup & dev:
  - Node: use a node version that matches `package.json` `engines` constraint.
  - Install: `npm ci` or `npm install`.
  - Start dev server: `npm run dev` (runs `toml:watch` in background and `astro dev`).
  - Build & preview: `npm run build` then `npm run preview`.
- Tests: `npm test` (uses Jest with `ts-jest` and runs in watch mode by default). Tests live in `src/__tests__/`.
- Generate help content: `node scripts/scrape-help.mjs` — re-runs Puppeteer scraping and regenerates `src/content/help/*` markdown and `public/images/help/*`.
  - After scraping: commit generated markdown + images. Exclude debug HTML dumps (`scripts/debug-*.html`).
- Other useful scripts: `npm run generate-favicons`, `npm run remove-multilingual`, `npm run remove-draft-from-sitemap` (post-build cleanup).

## Debugging & common pitfalls

- 404s caused by trailingSlash: check `astro.config.mjs` and `.astro/config.generated.json`. If `trailingSlash` is configured to `always`, ensure frontmatter `route` values and links include a trailing `/` (scripts were updated to write trailing slashes for `help` routes).
- When a page 404s:
  - Verify content file exists under `src/content/...` and frontmatter route matches expected path.
  - If route missing, re-run `node scripts/scrape-help.mjs` (help content) or add page template under `src/pages/help/[slug]/index.astro` to serve `/help/<slug>/`.
- Content schemas: Check `src/content.config.ts` to see required/optional fields for page types.

## Integration points & external dependencies

- The help scraper hits `https://www.voicetophone.com/help/...` and sometimes posts to `/respuesta2` to fetch answers. Puppeteer + direct POST are used when JS loads answers dynamically.
- Image processing uses `sharp` for optimizing downloaded images.
- Sitemap and SEO are handled through `@astrojs/sitemap` if enabled in `.astro/config.generated.json`.

## Commit guidance for generated content

- Generated content (help markdown + images) should be committed when updated; include a short message like `chore(help): regenerate help content`.
- Exclude temporary debug files: `scripts/debug-*.html`, local-only scripts, and large temp files.

## Quick examples and references

- Regenerate help content (example):
  - node scripts/scrape-help.mjs
  - git add src/content/help public/images/help && git commit -m "chore(help): update generated help content"
- Where to look for frontmatter patterns:
  - `src/content/help/spanish/inquietudes-basicas.md` — example section with `qids` and `route`.
  - `src/content/help/spanish/inquietudes-basicas/como-empezar.md` — example per-question page with `route` and `parent`.

---

If anything is unclear or you want me to include repository-specific CI rules, branch policies, or additional agent guidelines (e.g., how to run the scraper in CI safely), tell me which area to expand and I’ll iterate.
