---
import Base from "@/layouts/Base.astro";
import PageHeader from "@/components/widgets/PageHeader.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import { getCollectionCTM, getEntryCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import config from ".astro/config.generated.json" assert { type: "json" };

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const index = await getEntryCTM(
        "rate-virtual-number-by-country",
        "-index",
        lang.languageCode,
      );

      let pages = await getCollectionCTM(
        "rate-virtual-number-by-country",
        lang.languageCode,
      );

      // Exclude index entries (works for .md and .mdx)
      pages = pages.filter(
        (p) => !p.id.replace(/\.(md|mdx)$/, "").endsWith("-index"),
      );

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (index?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return pages.map((page) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            page.data?.customSlug ||
            page.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          page,
          pageIndex: index,
        },
      }));
    }),
  );

  return paths.flat();
}

const { page, pageIndex: entry } = Astro.props;
const { title, description, continent } = page.data;
const { Content } = page ? await page.render() : { Content: null };
---

<Base {...page.data}>
  <section class="section bg-white p-2 pt-12">
    <article class="container" data-aos="fade-down">
      <div class="mb-8 flex items-center gap-3 text-sm font-medium">
        <a href="/" class="text-gray-400 transition-colors hover:text-blue-600">
          Inicio
        </a>

        <img
          src="/images/arrow-down.png"
          alt="arrow icon"
          class="h-2 w-2 -rotate-90 object-contain opacity-40"
        />

        <a href="#" class="text-gray-400 transition-colors hover:text-blue-600">
          Números Virtuales
        </a>

        <img
          src="/images/arrow-down.png"
          alt="arrow icon"
          class="h-2 w-2 -rotate-90 object-contain opacity-40"
        />

        <span class="font-bold text-neutral-600">
          {title}
        </span>
      </div>
      <section class="flex flex-wrap items-start gap-12 lg:flex-nowrap">
        <div class="w-full lg:w-7/12">
          <div class="mb-4 flex items-center gap-2">
            <span class="text-2xl font-bold text-black">DE</span>
            <span
              class="rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold text-blue-600">
              {continent}
            </span>
          </div>

          <h1 class="mb-6 text-4xl font-bold text-black lg:text-6xl">
            Número Virtual en {title}
          </h1>

          <p class="text-text-default mb-8 max-w-xl text-lg">
            {description}
          </p>

          <div class="mb-10 flex gap-4">
            {
              ["SMS", "Fax", "Voice"].map((item) => (
                <span class="flex items-center gap-1 rounded bg-green-50 px-3 py-1 font-medium text-green-600">
                  <svg
                    class="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                  {item}
                </span>
              ))
            }
          </div>

          <div class="flex items-center gap-4">
            <a
              href="#"
              class="btn btn-primary flex items-center gap-2 rounded-xl bg-blue-600 px-8 py-4 text-white transition-colors duration-100 ease-in hover:bg-blue-500">
              Obtener Número <i
                class="fa-solid fa-arrow-up-right-from-square text-xs">
              </i>
            </a>
            <button
              class="flex size-12 items-center justify-center rounded-full bg-blue-500 transition-transform delay-75 duration-200 ease-in-out hover:scale-110 hover:bg-blue-400">
              <img
                src="/images/top-right.png"
                alt="diagonal arrow"
                class="h-auto w-5 object-contain"
              />
            </button>
            <a
              href="#"
              class="btn flex items-center gap-2 rounded-xl border border-blue-600 px-8 py-4 text-blue-600">
              Contactar Ventas
            </a>
            <button
              class="flex size-12 items-center justify-center rounded-full bg-blue-500 transition-transform delay-75 duration-200 ease-in-out hover:scale-110 hover:bg-blue-400">
              <img
                src="/images/top-right.png"
                alt="diagonal arrow"
                class="h-auto w-5 object-contain"
              />
            </button>
          </div>
        </div>

        <div class="w-full lg:w-5/12">
          <div
            class="rounded-3xl border border-gray-100 bg-white p-10 shadow-[0_10px_50px_rgba(0,0,0,0.08)]">
            <div class="mb-8 text-center">
              <p class="text-gray-400">Desde</p>
              <div class="flex items-start justify-center">
                <span class="mt-2 text-4xl font-bold text-blue-600">$</span>
                <span class="text-7xl font-extrabold text-blue-600">
                  {page.data.price || "7"}
                </span>
                <span class="mb-2 ml-1 self-end text-gray-400">/mes</span>
              </div>
            </div>

            <ul class="mb-8 space-y-4">
              {
                [
                  "Activación inmediata",
                  "Sin contratos a largo plazo",
                  "Soporte 24/7",
                  "Panel de control incluido",
                ].map((feature) => (
                  <li class="flex items-center gap-3 text-gray-700">
                    <div class="rounded-full bg-green-100 p-1">
                      <svg
                        class="h-4 w-4 text-green-600"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M5 13l4 4L19 7"
                        />
                      </svg>
                    </div>
                    {feature}
                  </li>
                ))
              }
            </ul>

            <div class="rounded-xl border border-orange-100 bg-orange-50 p-4">
              <div
                class="mb-1 flex items-center gap-2 text-sm font-bold text-orange-700">
                <svg
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                  </path>
                </svg>
                Requisitos
              </div>
              <p class="text-xs text-orange-600">
                No se requiere documentación
              </p>
            </div>
          </div>
        </div>
      </section>
    </article>
  </section>

  <section class="bg-gray-50 py-24" data-aos="fade-right">
    <div class="container mx-auto max-w-6xl px-4">
      <div class="prose-styles table-container">
        <Content />
      </div>
    </div>
  </section>

  <section class="w-full bg-gray-50 py-16" data-aos="fade-left">
    <div class="container mx-auto max-w-7xl px-4">
      <div class="flex w-full flex-col gap-6 md:flex-row">
        {
          [
            {
              title: "Llamadas Entrantes",
              description:
                "Recibe llamadas de clientes locales en tu número virtual y redirigelas a cualquier dispositivo",
              img: "/images/phone-call.png",
            },
            {
              title: "Presencia Local",
              description: `Muestra un número local de ${title} a tus clientes sin necesidad de oficina física`,
              img: "/images/internet.png",
            },
            {
              title: "Fácil Configuración",
              description:
                "Configura tu numero en minutos con nuestro panel de control intuitivo",
              img: "/images/settings.png",
            },
          ].map((info) => (
            <button class="flex flex-1 flex-col items-start rounded-[2.5rem] border border-gray-100 bg-white p-10 shadow-sm transition-all hover:-translate-y-1 hover:shadow-md">
              <div class="mb-8 flex h-14 w-14 items-center justify-center rounded-2xl bg-blue-50">
                <img
                  src={info.img}
                  alt={info.title}
                  class="h-7 w-7 object-contain"
                />
              </div>

              <h3 class="mb-4 text-2xl font-bold text-[#00153D]">
                {info.title}
              </h3>

              <p class="text-base leading-relaxed text-gray-500">
                {info.description}
              </p>
            </button>
          ))
        }
      </div>
    </div>
  </section>

  <section
    class="container-section relative overflow-hidden bg-white py-24"
    data-aos="fade-up"
    data-aos-duration="2000">
    <div class="relative z-10 container mx-auto max-w-7xl px-4">
      <div class="grid grid-cols-1 items-center gap-16 lg:grid-cols-2">
        <div>
          <span
            class="mb-6 inline-block rounded-full bg-blue-50 px-4 py-1.5 text-sm font-bold text-blue-600">
            Solución a medida
          </span>
          <h2
            class="mb-8 text-4xl leading-tight font-extrabold text-[#00153D] lg:text-5xl">
            Diseñamos la solución perfecta para tu negocio
          </h2>
          <p class="max-w-lg text-lg leading-relaxed text-gray-500">
            Nuestro equipo analiza tu infraestructura y necesidades...
          </p>
        </div>

        <div class="border-l border-gray-100">
          <div class="grid grid-cols-2 border-b border-gray-100 py-10 pl-8">
            <div class="flex flex-col">
              <span
                class="has-animated-number text-h2 md:text-h1 from-primary bg-linear-to-b via-white via-80% to-transparent bg-clip-text leading-none font-semibold text-transparent">
                <span class="counter" data-target="99.9">0</span>%
              </span>
              <span class="text-lg font-bold text-[#00153D]">
                Disponibilidad
              </span>
            </div>
            <p class="flex items-center text-sm text-gray-400">
              Tu sistema siempre en línea.
            </p>
          </div>

          <div class="grid grid-cols-2 border-b border-gray-100 py-10 pl-8">
            <p class="flex items-center text-sm text-gray-400">
              Llamadas VoIP más económicas.
            </p>
            <div class="flex flex-col">
              <span
                class="as-animated-number text-h2 md:text-h1 from-primary bg-linear-to-b via-white via-80% to-transparent bg-clip-text leading-none font-semibold text-transparent">
                <span class="counter" data-target="50">0</span>%
              </span>
              <span class="text-lg font-bold text-[#00153D]">
                Ahorro Garantizado
              </span>
            </div>
          </div>

          <div class="grid grid-cols-2 py-10 pl-8">
            <div class="flex flex-col">
              <span
                class="as-animated-number text-h2 md:text-h1 from-primary bg-linear-to-b via-white via-80% to-transparent bg-clip-text leading-none font-semibold text-transparent">
                <span class="counter" data-target="5">0</span>min
              </span>
              <span class="text-lg font-bold text-[#00153D]">
                Implementación Rápida
              </span>
            </div>
            <p class="flex items-center text-sm text-gray-400">
              Tu sistema listo en minutos.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base>

<style is:global>
  @reference "tailwindcss";

  .shadow-premium {
    box-shadow: 0 20px 50px -12px rgba(0, 21, 61, 0.12) !important;
  }

  .table-container h1:first-of-type,
  .table-container h2:first-of-type {
    display: none !important;
  }

  .table-container table {
    @apply my-0! max-w-4xl border-separate border-spacing-y-3;
    display: block !important;
    max-height: 450px !important;
    overflow-y: auto !important;
    border: none !important;
    overscroll-behavior: contain;
    scroll-behavior: smooth;
  }

  .table-container tbody td {
    @apply border-none! bg-white px-6 py-5 font-semibold text-black;
  }

  .table-container thead th {
    @apply sticky top-0 z-20 bg-white px-6 py-4 text-left text-sm font-bold tracking-wider text-gray-400 uppercase;
    border-bottom: 1px solid #f3f4f6;
  }

  .table-container tbody tr {
    @apply transition-colors hover:bg-gray-50/50;
  }

  .table-container tbody td {
    @apply border-b border-gray-50 px-6 py-5 text-base font-semibold text-[#00153D];
  }

  .table-container tbody td:nth-child(2) span,
  .table-container tbody td:nth-child(2) {
    @apply font-medium text-gray-400;
  }

  .table-container tbody td:nth-child(3) {
    @apply font-bold text-blue-600;
  }

  .table-container tbody td:last-child {
    @apply text-right font-bold text-blue-600;
  }

  .table-container tbody td:last-child::after {
    content: "Solicitar →";
    @apply ml-4 cursor-pointer text-blue-600 hover:underline;
    display: inline-block;
  }

  .table-container tbody tr:last-child td {
    border-bottom: none;
  }
</style>

<script is:inline>
  const animateCounter = (el) => {
    const target = parseFloat(el.getAttribute("data-target"));
    const duration = 2000;
    const frameRate = 1000 / 60;
    const totalFrames = Math.round(duration / frameRate);
    let currentFrame = 0;

    const update = () => {
      currentFrame++;

      const progress = currentFrame / totalFrames;

      const easeOut = 1 - Math.pow(1 - progress, 3);
      const currentValue = target * easeOut;

      if (currentFrame < totalFrames) {
        el.innerText = currentValue.toFixed(target % 1 === 0 ? 0 : 1);
        requestAnimationFrame(update);
      } else {
        el.innerText = target;
      }
    };

    update();
  };

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const counters = entry.target.querySelectorAll(".counter");
          counters.forEach((counter) => {
            counter.innerText = "0";
            animateCounter(counter);
          });
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.3 },
  );

  const section = document.querySelector(".container-section");
  if (section) observer.observe(section);

  const tableElement = document.querySelector(".table-container table");

  if (tableElement) {
    tableElement.addEventListener("mouseleave", () => {
      tableElement.style.overflowY = "hidden";

      setTimeout(() => {
        tableElement.style.overflowY = "auto";
      }, 10);
    });
  }
</script>
