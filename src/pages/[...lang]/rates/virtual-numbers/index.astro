---
import Base from "@/layouts/Base.astro";
import { getEntryCTM, getCollectionCTM } from "@/lib/contentParser.astro";
import handleDraftPage from "@/lib/utils/handleDraftPage";
import CallToAction from "@/components/sections/CallToAction.astro";
import { generatePaths, getLocaleUrlCTM } from "@/lib/utils/i18nUtils.ts";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";

export function getStaticPaths() {
  return generatePaths();
}

const entry = await getEntryCTM(
  "rate-virtual-number-by-country",
  "-index",
  Astro.currentLocale,
);

// Remove drafts pages in production
const response = handleDraftPage(entry?.data);
if (response) return response;

let pages = await getCollectionCTM(
  "rate-virtual-number-by-country",
  Astro.currentLocale,
);

// Exclude index entries (works for .md and .mdx)
pages = pages.filter(
  (p) => !p.id.replace(/\.(md|mdx)$/, "").endsWith("-index"),
);

// Sort pages by title (A-Z) and group by first letter for an alphabetical index
pages = pages.sort((a, b) =>
  (a.data?.title || "").localeCompare(b.data?.title || "", "es", {
    sensitivity: "base",
  }),
);

const grouped = pages.reduce((acc, p) => {
  const title = (p.data?.title || "").trim();
  const letter = title ? title[0].toUpperCase() : "#";
  if (!acc[letter]) acc[letter] = [];
  acc[letter].push(p);
  return acc;
}, {});

const letters = Object.keys(grouped).sort((a, b) =>
  a.localeCompare(b, "es", { sensitivity: "base" }),
);

const { Content } = await entry.render();
---

<Base {...entry?.data}>
  <section>
    <OptimizedImage
      src="/images/rates/virtual-numbers-header.jpg"
      alt="Virtual Numbers"
      class="h-64 w-full object-cover"
      width={1920}
      height={400}
      loading="lazy"
    />
    <div class="container">
      <div class="mx-auto max-w-5xl">
        {
          entry?.data?.title && (
            <h1 class="text-4xl" set:html={entry?.data?.title} />
          )
        }
        {
          entry?.data?.description && (
            <p
              class="mt-4 text-lg opacity-70"
              set:html={entry?.data?.description}
            />
          )
        }

        <div class="prose-styles mt-10 md:mt-20">
          <Content />
        </div>

        <div class="mt-12 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
          <h2 class="col-span-full mb-4 text-2xl font-semibold">
            {Astro.currentLocale == "es" ? "Países" : "Countries"}
          </h2>

          {
            letters.map((letter) => {
              return (
                <div class="mb-6">
                  <h3 class="mt-4 text-xl font-semibold">{letter}</h3>
                  <ul class="mt-2 grid grid-cols-1 gap-2">
                    {grouped[letter].map((r) => {
                      const slug =
                        r.data?.customSlug ||
                        r.id
                          .replace(/\.mdx?|\.md/g, "")
                          .split("/")
                          .pop();
                      const url = getLocaleUrlCTM(
                        `/rates/virtual-numbers/${slug}/`,
                        Astro.currentLocale,
                      );

                      return (
                        <li>
                          <a class="link" href={url}>
                            {r.data.title}
                          </a>
                        </li>
                      );
                    })}
                  </ul>
                </div>
              );
            })
          }
        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base>
