---
import CallToAction from "@/components/sections/CallToAction.astro";
import FaqSection from "@/components/sections/FaqSection.astro";
import ServiceDetailsSection from "@/components/sections/ServiceDetailsSection.astro";
import ServiceImpact from "@/components/sections/ServiceImpact.astro";
import ServiceSingleIntro from "@/components/sections/PageIntroSection.astro";
import ServicesSection from "@/components/sections/ServicesSection.astro";
import PageHeader from "@/components/widgets/PageHeader.astro";
import { markdownify } from "@/lib/utils/textConverter";
import { getLocaleUrlCTM } from "@/lib/utils/i18nUtils.ts";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import Base from "@/layouts/Base.astro";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import config from ".astro/config.generated.json" assert { type: "json" };

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { servicesFolder } = config.settings;
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const serviceIndex = await getEntryCTM(
        servicesFolder as "services",
        "-index",
        lang.languageCode,
      );

      let services = await getCollectionCTM(
        servicesFolder as "services",
        lang.languageCode,
      );

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (serviceIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return services.map((service) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            service.data?.customSlug ||
            service.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          service,
          serviceIndex,
        },
      }));
    }),
  );

  return paths.flat();
}

const { service, serviceIndex: entry } = Astro.props;
const rateIndex = await getEntryCTM("rates", "-index", Astro.currentLocale);
const ratesData = rateIndex?.data;
---

<Base {...service.data}>
  <PageHeader {...service.data} />
  <ServiceSingleIntro
    content={service.data.intro}
    serviceImage={service.data.image}
  />
  <ServiceDetailsSection content={service.data.details} />
  <ServiceImpact content={service.data.impact} />

  {
    ratesData && (
      <section class="my-12">
        <div class="container">
          <div class="grid gap-8 lg:grid-cols-2 lg:items-center">
            <div>
              {ratesData.title && (
                <h2
                  class="text-h4 mb-4"
                  set:html={markdownify(ratesData.title)}
                />
              )}
              {ratesData.description && (
                <p class="mb-6" set:html={markdownify(ratesData.description)} />
              )}
              <div>
                <a
                  class="btn btn-outline"
                  href={getLocaleUrlCTM("", Astro.currentLocale)}>
                  Ver Precios
                </a>
              </div>
            </div>
            {ratesData.image && (
              <div>
                <OptimizedImage
                  src={ratesData.image}
                  alt={ratesData.title}
                  class="h-56 w-full rounded-lg object-cover lg:h-72"
                />
              </div>
            )}
          </div>
        </div>
      </section>
    )
  }

  <ServicesSection content={entry?.data.servicesSection} />
  <FaqSection content={entry?.data.faqSection} />
  <CallToAction />
</Base>
